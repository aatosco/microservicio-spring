# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
  - feature-ms-abrahamTosco-mensaje

stages:
  - stage: Build
    displayName: 'Build Stage'
    jobs:
      - job: BuildJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Gradle@3
            inputs:
              gradleWrapperFile: 'gradlew'
              tasks: 'build'
              publishJUnitResults: true
              testResultsFiles: '**/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              sonarQubeRunAnalysis: false
              spotBugsAnalysis: false
            displayName: 'Compilacion/Build'

  - stage: Docker
    displayName: 'Docker Stage'
    dependsOn: Build
    jobs:
      - job: DockerJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'DockerHub'
              command: 'login'
            displayName: 'Login_Docker'

          - task: Docker@2
            inputs:
              containerRegistry: 'DockerHub'
              repository: 'aatosco/microservicio-spring'
              command: 'build'
              Dockerfile: '**/Dockerfile'
            displayName: 'Build_Imagen_Docker'

          - task: Docker@2
            inputs:
              containerRegistry: 'DockerHub'
              repository: 'aatosco/microservicio-spring'
              command: 'push'
            displayName: 'Push_Imagen_Docker'

  - stage: Deploy
    displayName: 'Deploy Stage'
    dependsOn: Docker
    jobs:
      - job: DeployJob
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Kubernetes@1
            inputs:
              connectionType: 'None'
              command: 'create'
              arguments: 'deployment microservicio-spring --image=aatosco/microservicio-spring:latest'

          - script: kubectl port-forward deployment/microservicio-spring 8082:8085


